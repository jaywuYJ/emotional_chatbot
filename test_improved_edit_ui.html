<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¹è¿›çš„ç¼–è¾‘åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9fafb;
        }
        .message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            position: relative;
        }
        .user { 
            background-color: #e3f2fd; 
            margin-left: 50px;
        }
        .assistant { 
            background-color: #f3e5f5; 
            margin-right: 50px;
        }
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        .action-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .action-btn:hover:not(:disabled) {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        .action-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .edit-form {
            margin-top: 10px;
            padding: 15px;
            background-color: #fff3e0;
            border-radius: 8px;
            border: 2px solid #f59e0b;
        }
        .edit-textarea {
            width: 100%;
            height: 80px;
            margin: 8px 0;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }
        .edit-textarea:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .edit-btn {
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .cancel-btn {
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
        }
        .save-btn {
            border: 1px solid #6366f1;
            background: #6366f1;
            color: white;
        }
        .save-btn:disabled {
            background: #9ca3af;
            border-color: #9ca3af;
            cursor: not-allowed;
        }
        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .delete-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #ef4444;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }
        .info { background-color: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <h1>æ”¹è¿›çš„ç¼–è¾‘åŠŸèƒ½æµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢æ¼”ç¤ºäº†æ”¹è¿›åçš„ç¼–è¾‘åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p>
    <ul>
        <li>âœ… é˜²æ­¢é‡å¤æäº¤</li>
        <li>âœ… åŠ è½½çŠ¶æ€æŒ‡ç¤º</li>
        <li>âœ… æŒ‰é’®çŠ¶æ€å˜åŒ–</li>
        <li>âœ… è¾“å…¥æ¡†ç¦ç”¨</li>
        <li>âœ… æ¸©å’Œçš„æˆåŠŸæç¤º</li>
    </ul>
    
    <div id="messages"></div>
    
    <div>
        <h3>å‘é€æ–°æ¶ˆæ¯</h3>
        <textarea id="newMessage" placeholder="è¾“å…¥æ¶ˆæ¯..." style="width: 100%; height: 60px; padding: 8px;"></textarea>
        <button onclick="sendMessage()" style="margin-top: 8px; padding: 8px 16px;">å‘é€</button>
    </div>
    
    <div id="status"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let messages = [];
        let currentSessionId = null;
        const currentUserId = 'test_user_ui';
        let editingMessageId = null;
        let isEditingSaving = false;
        let isDeletingMessage = null;

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return 'ui_test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function displayMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            messages.forEach((message, index) => {
                const div = document.createElement('div');
                div.className = `message ${message.role}`;
                
                const isEditing = editingMessageId === message.id;
                const isDeleting = isDeletingMessage === message.id;
                
                div.innerHTML = `
                    <div><strong>${message.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– AI'}:</strong></div>
                    ${isEditing ? `
                        <div class="edit-form">
                            <div>ç¼–è¾‘æ¶ˆæ¯ï¼š</div>
                            <textarea 
                                id="edit-content-${index}" 
                                class="edit-textarea"
                                ${isEditingSaving ? 'disabled' : ''}
                            >${message.content}</textarea>
                            <div class="edit-actions">
                                <button 
                                    class="edit-btn cancel-btn" 
                                    onclick="cancelEdit()"
                                    ${isEditingSaving ? 'disabled' : ''}
                                >
                                    å–æ¶ˆ
                                </button>
                                <button 
                                    class="edit-btn save-btn" 
                                    onclick="saveEdit(${index})"
                                    ${isEditingSaving ? 'disabled' : ''}
                                >
                                    ${isEditingSaving ? '<div class="spinner"></div>ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div style="margin: 8px 0;">${message.content}</div>
                    `}
                    
                    ${message.role === 'user' && !isEditing ? `
                        <div class="message-actions">
                            <button 
                                class="action-btn" 
                                onclick="editMessage(${index})"
                                ${isEditingSaving || isDeleting ? 'disabled' : ''}
                            >
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button 
                                class="action-btn" 
                                onclick="deleteMessage(${index})"
                                ${isEditingSaving || isDeleting ? 'disabled' : ''}
                                style="color: ${isDeleting ? '#ef4444' : '#9ca3af'}"
                            >
                                ${isDeleting ? '<div class="delete-spinner"></div>åˆ é™¤ä¸­...' : 'ğŸ—‘ï¸ æ’¤å›'}
                            </button>
                        </div>
                    ` : ''}
                    
                    <small style="color: #6b7280;">ID: ${message.id}</small>
                `;
                container.appendChild(div);
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const textarea = document.getElementById('newMessage');
            const content = textarea.value.trim();
            if (!content) return;

            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            try {
                showStatus('å‘é€æ¶ˆæ¯ä¸­...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: content,
                        user_id: currentUserId,
                        session_id: currentSessionId
                    })
                });

                const result = await response.json();
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                messages.push({
                    id: result.message_id,
                    role: 'user',
                    content: content,
                    user_id: currentUserId
                });

                // æ·»åŠ AIå›å¤
                messages.push({
                    id: 'ai_' + Date.now(),
                    role: 'assistant',
                    content: result.response,
                    user_id: currentUserId
                });

                textarea.value = '';
                displayMessages();
                showStatus('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showStatus('âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¼–è¾‘æ¶ˆæ¯
        function editMessage(index) {
            if (isEditingSaving || isDeletingMessage) return;
            
            editingMessageId = messages[index].id;
            displayMessages();
            
            // èšç„¦åˆ°ç¼–è¾‘æ¡†
            setTimeout(() => {
                const textarea = document.getElementById(`edit-content-${index}`);
                if (textarea) {
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                }
            }, 100);
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingMessageId = null;
            isEditingSaving = false;
            displayMessages();
        }

        // ä¿å­˜ç¼–è¾‘
        async function saveEdit(index) {
            if (isEditingSaving) return; // é˜²æ­¢é‡å¤æäº¤
            
            const message = messages[index];
            const newContent = document.getElementById(`edit-content-${index}`).value.trim();
            
            if (!newContent) {
                showStatus('âŒ æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            // è®¾ç½®åŠ è½½çŠ¶æ€
            isEditingSaving = true;
            displayMessages(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºåŠ è½½çŠ¶æ€

            try {
                showStatus('ä¿å­˜ç¼–è¾‘ä¸­...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/chat/messages/${message.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        new_content: newContent
                    })
                });

                const result = await response.json();

                if (result.new_response) {
                    // é‡æ–°ç”Ÿæˆäº†å¯¹è¯
                    // æ›´æ–°ç¼–è¾‘çš„æ¶ˆæ¯
                    messages[index].content = newContent;
                    
                    // åˆ é™¤è¯¥æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
                    messages = messages.slice(0, index + 1);
                    
                    // æ·»åŠ æ–°çš„AIå›å¤
                    messages.push({
                        id: 'ai_' + Date.now(),
                        role: 'assistant',
                        content: result.new_response.content,
                        user_id: currentUserId
                    });

                    showStatus(`âœ… æ¶ˆæ¯ç¼–è¾‘æˆåŠŸï¼Œå·²é‡æ–°ç”Ÿæˆå¯¹è¯ï¼ˆåˆ é™¤äº†${result.deleted_messages_count}æ¡æ¶ˆæ¯ï¼‰`, 'success');
                } else {
                    // åªæ˜¯ç®€å•æ›´æ–°
                    messages[index].content = newContent;
                    showStatus('âœ… æ¶ˆæ¯ç¼–è¾‘æˆåŠŸ', 'success');
                }

                // é‡ç½®ç¼–è¾‘çŠ¶æ€
                editingMessageId = null;
                displayMessages();
                
            } catch (error) {
                console.error('ç¼–è¾‘æ¶ˆæ¯å¤±è´¥:', error);
                showStatus('âŒ ç¼–è¾‘æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½é‡ç½®åŠ è½½çŠ¶æ€
                isEditingSaving = false;
                displayMessages();
            }
        }

        // åˆ é™¤æ¶ˆæ¯
        async function deleteMessage(index) {
            if (isEditingSaving || isDeletingMessage) return;
            
            const message = messages[index];
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿå¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œå°†åŒæ—¶åˆ é™¤å¯¹åº”çš„AIå›å¤ã€‚')) return;

            // è®¾ç½®åˆ é™¤çŠ¶æ€
            isDeletingMessage = message.id;
            displayMessages();

            try {
                showStatus('åˆ é™¤æ¶ˆæ¯ä¸­...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/chat/messages/${message.id}?user_id=${currentUserId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                console.log('åˆ é™¤ç»“æœ:', result);

                // æ ¹æ®åç«¯è¿”å›çš„åˆ é™¤ä¿¡æ¯æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                if (result.deleted_messages && result.deleted_messages.length > 0) {
                    // åˆ é™¤æ‰€æœ‰è¢«åˆ é™¤çš„æ¶ˆæ¯
                    messages = messages.filter(msg => {
                        const msgId = parseInt(msg.id) || msg.id;
                        return !result.deleted_messages.includes(msgId);
                    });
                    
                    showStatus(`âœ… æˆåŠŸåˆ é™¤ ${result.deleted_count} æ¡æ¶ˆæ¯`, 'success');
                } else {
                    // å›é€€åˆ°åˆ é™¤å•æ¡æ¶ˆæ¯
                    messages.splice(index, 1);
                    showStatus('âœ… æ¶ˆæ¯åˆ é™¤æˆåŠŸ', 'success');
                }
                
                displayMessages();
            } catch (error) {
                console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
                showStatus('âŒ åˆ é™¤æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                // é‡ç½®åˆ é™¤çŠ¶æ€
                isDeletingMessage = null;
                displayMessages();
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = '';
                }, 3000);
            }
        }

        // åˆå§‹åŒ–
        displayMessages();
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                const newMessageTextarea = document.getElementById('newMessage');
                if (document.activeElement === newMessageTextarea) {
                    sendMessage();
                }
            }
        });
    </script>
</body>
</html>