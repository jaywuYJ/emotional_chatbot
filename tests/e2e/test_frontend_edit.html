<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试消息编辑功能</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .user { background-color: #e3f2fd; }
        .assistant { background-color: #f3e5f5; }
        .edit-form {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3e0;
            border-radius: 4px;
        }
        textarea {
            width: 100%;
            height: 60px;
            margin: 5px 0;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>消息编辑功能测试</h1>
    
    <div id="messages"></div>
    
    <div>
        <h3>发送新消息</h3>
        <textarea id="newMessage" placeholder="输入消息..."></textarea>
        <button onclick="sendMessage()">发送</button>
    </div>
    
    <div id="status"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let messages = [];
        let currentSessionId = null;
        const currentUserId = 'test_user';

        // 生成会话ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 显示消息
        function displayMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            messages.forEach((message, index) => {
                const div = document.createElement('div');
                div.className = `message ${message.role}`;
                div.innerHTML = `
                    <strong>${message.role === 'user' ? '用户' : 'AI'}:</strong> ${message.content}
                    <small>(ID: ${message.id})</small>
                    ${message.role === 'user' ? `
                        <button onclick="editMessage(${index})">编辑</button>
                        <button onclick="deleteMessage(${index})">删除</button>
                    ` : ''}
                    <div id="edit-${index}" class="edit-form" style="display: none;">
                        <textarea id="edit-content-${index}">${message.content}</textarea>
                        <button onclick="saveEdit(${index})">保存</button>
                        <button onclick="cancelEdit(${index})">取消</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 发送消息
        async function sendMessage() {
            const textarea = document.getElementById('newMessage');
            const content = textarea.value.trim();
            if (!content) return;

            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: content,
                        user_id: currentUserId,
                        session_id: currentSessionId
                    })
                });

                const result = await response.json();
                
                // 添加用户消息
                messages.push({
                    id: result.message_id,
                    role: 'user',
                    content: content,
                    user_id: currentUserId
                });

                // 添加AI回复
                messages.push({
                    id: 'ai_' + Date.now(),
                    role: 'assistant',
                    content: result.response,
                    user_id: currentUserId
                });

                textarea.value = '';
                displayMessages();
                showStatus('消息发送成功', 'success');
            } catch (error) {
                console.error('发送消息失败:', error);
                showStatus('发送消息失败: ' + error.message, 'error');
            }
        }

        // 编辑消息
        function editMessage(index) {
            document.getElementById(`edit-${index}`).style.display = 'block';
        }

        // 取消编辑
        function cancelEdit(index) {
            document.getElementById(`edit-${index}`).style.display = 'none';
        }

        // 保存编辑
        async function saveEdit(index) {
            const message = messages[index];
            const newContent = document.getElementById(`edit-content-${index}`).value.trim();
            
            if (!newContent) {
                alert('消息内容不能为空');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/chat/messages/${message.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        new_content: newContent
                    })
                });

                const result = await response.json();
                console.log('编辑结果:', result);

                if (result.new_response) {
                    // 重新生成了对话
                    // 更新编辑的消息
                    messages[index].content = newContent;
                    
                    // 删除该消息之后的所有消息
                    messages = messages.slice(0, index + 1);
                    
                    // 添加新的AI回复
                    messages.push({
                        id: 'ai_' + Date.now(),
                        role: 'assistant',
                        content: result.new_response.content,
                        user_id: currentUserId
                    });

                    showStatus(`消息编辑成功，已重新生成对话（删除了${result.deleted_messages_count}条消息）`, 'success');
                } else {
                    // 只是简单更新
                    messages[index].content = newContent;
                    showStatus('消息编辑成功', 'success');
                }

                cancelEdit(index);
                displayMessages();
            } catch (error) {
                console.error('编辑消息失败:', error);
                showStatus('编辑消息失败: ' + error.message, 'error');
            }
        }

        // 删除消息
        async function deleteMessage(index) {
            const message = messages[index];
            
            if (!confirm('确定要删除这条消息吗？')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/chat/messages/${message.id}?user_id=${currentUserId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                console.log('删除结果:', result);

                messages.splice(index, 1);
                displayMessages();
                showStatus('消息删除成功', 'success');
            } catch (error) {
                console.error('删除消息失败:', error);
                showStatus('删除消息失败: ' + error.message, 'error');
            }
        }

        // 显示状态
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            setTimeout(() => {
                status.textContent = '';
                status.className = '';
            }, 3000);
        }

        // 初始化
        displayMessages();
    </script>
</body>
</html>