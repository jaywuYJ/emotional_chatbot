<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ReactçŠ¶æ€æ›´æ–°</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .user { background-color: #e3f2fd; }
        .assistant { background-color: #f3e5f5; }
        button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .debug {
            background-color: #fff3cd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;

        function TestApp() {
            const [messages, setMessages] = useState([
                {
                    id: 'history_test_session_123_107_2025-12-17T09:55:24',
                    role: 'user',
                    content: 'ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ',
                    dbId: 107,
                    user_id: 'test_user',
                    isHistory: true
                },
                {
                    id: 'history_test_session_123_108_2025-12-17T09:55:25',
                    role: 'assistant',
                    content: 'ä½ åœ¨å“ªé‡Œå‘¢ï¼Ÿå¯ä»¥å‘Šè¯‰æˆ‘ä½ æ‰€åœ¨çš„åŸå¸‚å—ï¼Ÿ',
                    dbId: 108,
                    user_id: 'test_user',
                    isHistory: true
                },
                {
                    id: 'history_test_session_123_109_2025-12-17T09:55:26',
                    role: 'user',
                    content: 'é‚£æ˜å¤©å‘¢ï¼Ÿ',
                    dbId: 109,
                    user_id: 'test_user',
                    isHistory: true
                },
                {
                    id: 'history_test_session_123_110_2025-12-17T09:55:27',
                    role: 'assistant',
                    content: 'ä½ æåˆ°"æ˜å¤©"ï¼Œæ˜¯æƒ³äº†è§£æ˜å¤©çš„å¤©æ°”...',
                    dbId: 110,
                    user_id: 'test_user',
                    isHistory: true
                }
            ]);

            const [debugInfo, setDebugInfo] = useState('');

            const handleMessageUpdate = useCallback((updatedMessage) => {
                console.log('handleMessageUpdate è¢«è°ƒç”¨:', updatedMessage);
                setDebugInfo(`handleMessageUpdate è¢«è°ƒç”¨: ${JSON.stringify(updatedMessage, null, 2)}`);
                
                if (updatedMessage.regenerated && updatedMessage.newResponse) {
                    console.log('å¤„ç†ç¼–è¾‘æ¶ˆæ¯å¹¶é‡æ–°ç”ŸæˆAIå›å¤çš„æƒ…å†µ');
                    setMessages(prevMessages => {
                        console.log('å½“å‰æ¶ˆæ¯åˆ—è¡¨:', prevMessages);
                        
                        const editedMessageIndex = prevMessages.findIndex(msg => msg.id === updatedMessage.id);
                        console.log('è¢«ç¼–è¾‘æ¶ˆæ¯ç´¢å¼•:', editedMessageIndex);
                        
                        if (editedMessageIndex === -1) {
                            console.log('æœªæ‰¾åˆ°è¢«ç¼–è¾‘çš„æ¶ˆæ¯');
                            setDebugInfo(prev => prev + '\nâŒ æœªæ‰¾åˆ°è¢«ç¼–è¾‘çš„æ¶ˆæ¯');
                            return prevMessages;
                        }
                        
                        const editedMessage = prevMessages[editedMessageIndex];
                        const messagesBeforeEdit = prevMessages.slice(0, editedMessageIndex);
                        const updatedEditedMessage = {
                            ...editedMessage,
                            content: updatedMessage.content,
                            timestamp: new Date().toISOString()
                        };
                        
                        const newAIMessage = {
                            id: `ai_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            role: 'assistant',
                            content: updatedMessage.newResponse.content,
                            emotion: updatedMessage.newResponse.emotion || 'neutral',
                            suggestions: updatedMessage.newResponse.suggestions || [],
                            timestamp: new Date().toISOString(),
                            user_id: 'test_user',
                            context: updatedMessage.newResponse.context || {}
                        };
                        
                        const newMessages = [
                            ...messagesBeforeEdit,
                            updatedEditedMessage,
                            newAIMessage
                        ];
                        
                        console.log('æ›´æ–°åçš„æ¶ˆæ¯åˆ—è¡¨:', newMessages);
                        setDebugInfo(prev => prev + `\nâœ… æ¶ˆæ¯æ›´æ–°æˆåŠŸï¼Œä» ${prevMessages.length} æ¡å˜ä¸º ${newMessages.length} æ¡`);
                        
                        return newMessages;
                    });
                } else {
                    console.log('å¤„ç†ç®€å•çš„æ¶ˆæ¯å†…å®¹æ›´æ–°');
                    setMessages(prevMessages => 
                        prevMessages.map(msg => 
                            msg.id === updatedMessage.id 
                                ? { ...msg, content: updatedMessage.content } 
                                : msg
                        )
                    );
                }
            }, []);

            const simulateEdit = () => {
                const messageToEdit = messages[0];
                console.log('æ¨¡æ‹Ÿç¼–è¾‘æ¶ˆæ¯:', messageToEdit);
                
                // æ¨¡æ‹Ÿç¼–è¾‘å“åº”
                const mockResponse = {
                    content: "ä»Šå¤©åŒ—äº¬çš„å¤©æ°”å¦‚ä½•ï¼Ÿ",
                    newResponse: {
                        content: "ä½ å¥½å‘€ï½è™½ç„¶ä½ é—®çš„æ˜¯åŒ—äº¬çš„å¤©æ°”ï¼Œä½†æˆ‘æ³¨æ„åˆ°ä½ ä¹‹å‰å‘è¿‡æµ‹è¯•ä¿¡æ¯ï¼Œå¯èƒ½è¿˜åœ¨ç†Ÿæ‚‰æˆ‘ä»¬çš„å¯¹è¯æ–¹å¼ã€‚æ²¡å…³ç³»ï¼Œæˆ‘å¾ˆé«˜å…´ä½ æ„¿æ„ç»§ç»­å’Œæˆ‘äº¤æµ ğŸŒ¤ï¸\n\nä»Šå¤©åŒ—äº¬å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨20â„ƒå·¦å³...",
                        emotion: "neutral",
                        suggestions: [],
                        context: {}
                    },
                    deletedCount: 3,
                    regenerated: true
                };

                handleMessageUpdate({
                    id: messageToEdit.id,
                    ...mockResponse
                });
            };

            return (
                <div>
                    <h1>ReactçŠ¶æ€æ›´æ–°æµ‹è¯•</h1>
                    
                    <button onClick={simulateEdit}>
                        æ¨¡æ‹Ÿç¼–è¾‘ç¬¬ä¸€æ¡æ¶ˆæ¯
                    </button>
                    
                    <div className="debug">
                        <strong>è°ƒè¯•ä¿¡æ¯:</strong>
                        <pre>{debugInfo}</pre>
                    </div>
                    
                    <h3>æ¶ˆæ¯åˆ—è¡¨ (å…± {messages.length} æ¡):</h3>
                    {messages.map((message, index) => (
                        <div key={message.id} className={`message ${message.role}`}>
                            <strong>{message.role === 'user' ? 'ç”¨æˆ·' : 'AI'}:</strong> {message.content}
                            <br />
                            <small>ID: {message.id}</small>
                            {message.dbId && <small> | DB ID: {message.dbId}</small>}
                        </div>
                    ))}
                </div>
            );
        }

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>